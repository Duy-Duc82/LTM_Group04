-- =========================================================
-- Schema: Millionaire Game (PostgreSQL)
-- =========================================================

-- =========================
-- USERS & SESSIONS & STATS
-- =========================
CREATE TABLE IF NOT EXISTS users (
  user_id       BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  username      VARCHAR(32)  NOT NULL UNIQUE,
  password      VARCHAR(255) NOT NULL,
  avatar_img    VARCHAR(512),
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS user_stats (
  user_id         BIGINT PRIMARY KEY,
  quickmode_games BIGINT NOT NULL DEFAULT 0,
  onevn_games     BIGINT NOT NULL DEFAULT 0,
  quickmode_wins  BIGINT NOT NULL DEFAULT 0,
  onevn_wins      BIGINT NOT NULL DEFAULT 0,
  CONSTRAINT fk_user_stats_user
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS user_sessions (
  id              BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  user_id         BIGINT NOT NULL,
  access_token    CHAR(64) NOT NULL UNIQUE,
  last_heartbeat  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at      TIMESTAMPTZ NOT NULL,
  CONSTRAINT fk_user_sessions_user
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_user_sessions_user ON user_sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_user_sessions_exp  ON user_sessions(expires_at);

-- =================
-- DIRECT MESSAGES
-- =================
CREATE TABLE IF NOT EXISTS direct_messages (
  id            BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  sender_id     BIGINT NOT NULL,
  receiver_id   BIGINT NOT NULL,
  message       TEXT   NOT NULL,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  is_delivered  BOOLEAN NOT NULL DEFAULT FALSE,
  delivered_at  TIMESTAMPTZ NULL,
  is_read       BOOLEAN NOT NULL DEFAULT FALSE,
  read_at       TIMESTAMPTZ NULL,
  CONSTRAINT fk_dm_sender   FOREIGN KEY (sender_id)   REFERENCES users(user_id) ON DELETE CASCADE,
  CONSTRAINT fk_dm_receiver FOREIGN KEY (receiver_id) REFERENCES users(user_id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_dm_pair     ON direct_messages (sender_id, receiver_id, created_at);
CREATE INDEX IF NOT EXISTS idx_dm_receiver ON direct_messages (receiver_id, is_delivered, is_read);

-- ===============
-- ROOM MESSAGES
-- (tạo trước, FK sẽ thêm sau khi có bảng room & users)
-- ===============
CREATE TABLE IF NOT EXISTS room_messages (
  id          BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  room_id     BIGINT NOT NULL,
  sender_id   BIGINT NOT NULL,
  message     TEXT   NOT NULL,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_room_messages_room ON room_messages(room_id, created_at);

-- =========
-- FRIENDS
-- =========
CREATE TABLE IF NOT EXISTS friends (
  user_id    BIGINT NOT NULL,
  friend_id  BIGINT NOT NULL,
  status     TEXT   NOT NULL CHECK (status IN ('PENDING','ACCEPTED','BLOCKED')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  PRIMARY KEY (user_id, friend_id),
  CONSTRAINT fk_friends_u1 FOREIGN KEY (user_id)   REFERENCES users(user_id) ON DELETE CASCADE,
  CONSTRAINT fk_friends_u2 FOREIGN KEY (friend_id) REFERENCES users(user_id) ON DELETE CASCADE,
  CONSTRAINT chk_friends_not_self CHECK (user_id <> friend_id)
);

CREATE INDEX IF NOT EXISTS idx_friends_status ON friends(status);

-- ================
-- FRIEND REQUESTS
-- ================
CREATE TABLE IF NOT EXISTS friend_request (
  rq_id         BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  from_user_id  BIGINT NOT NULL,
  to_user_id    BIGINT NOT NULL,
  status        TEXT   NOT NULL CHECK (status IN ('SENT','ACCEPTED','DECLINED','EXPIRED')),
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  responded_at  TIMESTAMPTZ NULL,
  CONSTRAINT fk_fr_from FOREIGN KEY (from_user_id) REFERENCES users(user_id) ON DELETE CASCADE,
  CONSTRAINT fk_fr_to   FOREIGN KEY (to_user_id)   REFERENCES users(user_id) ON DELETE CASCADE,
  CONSTRAINT chk_fr_not_self CHECK (from_user_id <> to_user_id)
);

CREATE INDEX IF NOT EXISTS idx_fr_to_status ON friend_request(to_user_id, status);

-- ===========
-- QUESTIONS
-- ===========
CREATE TABLE IF NOT EXISTS question (
  question_id      BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  difficulty_level TEXT NOT NULL CHECK (difficulty_level IN ('EASY','MEDIUM','HARD')),
  content          TEXT NOT NULL,
  op_a             VARCHAR(512) NOT NULL,
  op_b             VARCHAR(512) NOT NULL,
  op_c             VARCHAR(512) NOT NULL,
  op_d             VARCHAR(512) NOT NULL,
  correct_op       TEXT NOT NULL CHECK (correct_op IN ('A','B','C','D')),
  explanation      TEXT
);

CREATE INDEX IF NOT EXISTS idx_question_diff ON question(difficulty_level);

-- ======================
-- QUICK MODE (Solo 15Q)
-- ======================
CREATE TABLE IF NOT EXISTS quickmode_sessions (
  session_id     BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  user_id        BIGINT NOT NULL,
  status         TEXT NOT NULL CHECK (status IN ('IN_PROGRESS','FINISHED','FAILED')),
  current_round  INT  NOT NULL DEFAULT 1,
  total_correct  INT  NOT NULL DEFAULT 0,
  started_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ended_at       TIMESTAMPTZ NULL,
  CONSTRAINT fk_qs_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_qs_user_status ON quickmode_sessions(user_id, status);

CREATE TABLE IF NOT EXISTS quickmode_rounds (
  round_id         BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  session_id       BIGINT NOT NULL,
  round_number     INT    NOT NULL,
  question_id      BIGINT NOT NULL,
  difficulty_level TEXT   NOT NULL CHECK (difficulty_level IN ('EASY','MEDIUM','HARD')),
  time_limit       INT    NOT NULL DEFAULT 30,      -- seconds
  start_time       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT fk_qr_session  FOREIGN KEY (session_id)  REFERENCES quickmode_sessions(session_id) ON DELETE CASCADE,
  CONSTRAINT fk_qr_question FOREIGN KEY (question_id) REFERENCES question(question_id)
);
CREATE UNIQUE INDEX IF NOT EXISTS uq_qr_session_round ON quickmode_rounds(session_id, round_number);

CREATE TABLE IF NOT EXISTS round_answers (
  id            BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  round_id      BIGINT NOT NULL,
  user_id       BIGINT NOT NULL,
  selected_op   TEXT   NOT NULL CHECK (selected_op IN ('A','B','C','D')),
  is_correct    BOOLEAN NOT NULL,
  answered_at   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT fk_ra_round FOREIGN KEY (round_id) REFERENCES quickmode_rounds(round_id) ON DELETE CASCADE,
  CONSTRAINT fk_ra_user  FOREIGN KEY (user_id)  REFERENCES users(user_id) ON DELETE CASCADE
);
CREATE UNIQUE INDEX IF NOT EXISTS uq_ra_once ON round_answers(round_id, user_id);

-- 50:50 lifeline cho Quick Mode
CREATE TABLE IF NOT EXISTS lifeline_5050 (
  id               BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  session_id       BIGINT NOT NULL,
  round_id         BIGINT NOT NULL,
  user_id          BIGINT NOT NULL,
  removed_options  TEXT[] NOT NULL,
  is_used          BOOLEAN NOT NULL DEFAULT TRUE,
  used_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT fk_ll_session FOREIGN KEY (session_id) REFERENCES quickmode_sessions(session_id) ON DELETE CASCADE,
  CONSTRAINT fk_ll_round   FOREIGN KEY (round_id)   REFERENCES quickmode_rounds(round_id)   ON DELETE CASCADE,
  CONSTRAINT fk_ll_user    FOREIGN KEY (user_id)    REFERENCES users(user_id)               ON DELETE CASCADE,
  CONSTRAINT chk_ll_removed
    CHECK (
      cardinality(removed_options) = 2
      AND removed_options <@ ARRAY['A','B','C','D']::TEXT[]
    )
);

-- ============
-- 1vN ROOMS
-- ============
CREATE TABLE IF NOT EXISTS room (
  room_id                  BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  owner_id                 BIGINT NOT NULL,
  status                   TEXT NOT NULL CHECK (status IN ('WAITING','IN_PROGRESS','FINISHED')),
  current_number_players   INT  NOT NULL DEFAULT 0,
  max_number_players       INT  NOT NULL DEFAULT 8,
  created_at               TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  started_at               TIMESTAMPTZ NULL,
  ended_at                 TIMESTAMPTZ NULL,
  CONSTRAINT fk_room_owner FOREIGN KEY (owner_id) REFERENCES users(user_id)
);

CREATE INDEX IF NOT EXISTS idx_room_status ON room(status);

CREATE TABLE IF NOT EXISTS room_invites (
  id            BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  room_id       BIGINT NOT NULL,
  from_user_id  BIGINT NOT NULL,
  to_user_id    BIGINT NOT NULL,
  status        TEXT NOT NULL CHECK (status IN ('SENT','ACCEPTED','DECLINED','EXPIRED')),
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  responded_at  TIMESTAMPTZ NULL,
  CONSTRAINT fk_rinv_room FOREIGN KEY (room_id)      REFERENCES room(room_id)      ON DELETE CASCADE,
  CONSTRAINT fk_rinv_from FOREIGN KEY (from_user_id) REFERENCES users(user_id)     ON DELETE CASCADE,
  CONSTRAINT fk_rinv_to   FOREIGN KEY (to_user_id)   REFERENCES users(user_id)     ON DELETE CASCADE,
  CONSTRAINT chk_rinv_not_self CHECK (from_user_id <> to_user_id)
);

CREATE INDEX IF NOT EXISTS idx_rinv_to_status ON room_invites(to_user_id, status);

CREATE TABLE IF NOT EXISTS room_members (
  room_id   BIGINT NOT NULL,
  user_id   BIGINT NOT NULL,
  joined_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  PRIMARY KEY (room_id, user_id),
  CONSTRAINT fk_rmem_room FOREIGN KEY (room_id) REFERENCES room(room_id) ON DELETE CASCADE,
  CONSTRAINT fk_rmem_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

-- Bổ sung FK cho room_messages sau khi room & users đã có
ALTER TABLE room_messages
  ADD CONSTRAINT fk_room_messages_room
  FOREIGN KEY (room_id) REFERENCES room(room_id) ON DELETE CASCADE;

ALTER TABLE room_messages
  ADD CONSTRAINT fk_room_messages_sender
  FOREIGN KEY (sender_id) REFERENCES users(user_id) ON DELETE CASCADE;

-- ===============
-- 1vN SESSIONS
-- ===============
CREATE TABLE IF NOT EXISTS onevn_sessions (
  session_id   BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  room_id      BIGINT NOT NULL,
  winner_id    BIGINT NULL,
  status       TEXT NOT NULL CHECK (status IN ('IN_PROGRESS','FINISHED','ABORTED')),
  started_at   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ended_at     TIMESTAMPTZ NULL,
  CONSTRAINT fk_1s_room   FOREIGN KEY (room_id)   REFERENCES room(room_id)   ON DELETE CASCADE,
  CONSTRAINT fk_1s_winner FOREIGN KEY (winner_id) REFERENCES users(user_id)
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_onevn_room_active
  ON onevn_sessions(room_id, status)
  WHERE status = 'IN_PROGRESS';

CREATE TABLE IF NOT EXISTS onevn_players (
  user_id       BIGINT NOT NULL,
  session_id    BIGINT NOT NULL,
  score         INT    NOT NULL DEFAULT 0,
  is_eliminated BOOLEAN NOT NULL DEFAULT FALSE,
  final_rank    INT NULL,
  PRIMARY KEY (session_id, user_id),
  CONSTRAINT fk_1p_user    FOREIGN KEY (user_id)    REFERENCES users(user_id)             ON DELETE CASCADE,
  CONSTRAINT fk_1p_session FOREIGN KEY (session_id) REFERENCES onevn_sessions(session_id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS onevn_rounds (
  round_id     BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  session_id   BIGINT NOT NULL,
  round_no     INT NOT NULL,
  question_id  BIGINT NOT NULL,
  difficulty   TEXT NOT NULL CHECK (difficulty IN ('EASY','MEDIUM','HARD')),
  time_limit   INT NOT NULL DEFAULT 20,    -- seconds
  start_time   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT fk_1r_session  FOREIGN KEY (session_id)  REFERENCES onevn_sessions(session_id) ON DELETE CASCADE,
  CONSTRAINT fk_1r_question FOREIGN KEY (question_id) REFERENCES question(question_id)
);
CREATE UNIQUE INDEX IF NOT EXISTS uq_1r_session_no ON onevn_rounds(session_id, round_no);

CREATE TABLE IF NOT EXISTS onevn_answers (
  id              BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  round_id        BIGINT NOT NULL,
  user_id         BIGINT NOT NULL,
  selected_op     TEXT NOT NULL CHECK (selected_op IN ('A','B','C','D')),
  is_correct      BOOLEAN NOT NULL,
  point_awarded   INT NOT NULL DEFAULT 0,
  answered_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT fk_1a_round FOREIGN KEY (round_id) REFERENCES onevn_rounds(round_id) ON DELETE CASCADE,
  CONSTRAINT fk_1a_user  FOREIGN KEY (user_id)  REFERENCES users(user_id)       ON DELETE CASCADE
);
CREATE UNIQUE INDEX IF NOT EXISTS uq_1a_once ON onevn_answers(round_id, user_id);



